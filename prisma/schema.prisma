// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String     @id @default(uuid())
  firebaseUid           String     @unique
  email                 String     @unique
  createdAt             DateTime   @default(now())
  
  // Subscription fields
  stripeCustomerId      String?    @unique
  stripeSubscriptionId  String?    @unique
  stripePriceId         String?
  stripeCurrentPeriodEnd DateTime?
  subscriptionTier      String     @default("free") // free, pro, enterprise
  subscriptionStatus    String     @default("inactive") // inactive, active, canceled, past_due
  
  layouts               Layout[]
  analyses              Analysis[]
  automationSchedules   AutomationSchedule[]
  telegramConfig        TelegramConfig?
}

model Layout {
  id             String     @id @default(uuid())
  userId         String
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  layoutId       String?
  symbol         String?
  interval       String?
  sessionid      String?
  sessionidSign  String?
  createdAt      DateTime   @default(now())
  snapshots      Snapshot[]
  automationSchedule AutomationSchedule?
}

model Snapshot {
  id          String     @id @default(uuid())
  layoutId    String
  layout      Layout     @relation(fields: [layoutId], references: [id], onDelete: Cascade)
  url         String
  expiresAt   DateTime
  createdAt   DateTime   @default(now())
  analysis    Analysis?
}

model Analysis {
  id              String            @id @default(uuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  snapshotId      String            @unique
  snapshot        Snapshot          @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  action          String
  confidence      Int
  timeframe       String
  reasons         Json
  tradeSetup      Json?             // Trade setup details (quality, entry, stop loss, target, R:R ratio)
  createdAt       DateTime          @default(now())
  economicContext EconomicContext?
  history         AnalysisHistory[]
}

model EconomicEvent {
  id            String    @id @default(uuid())
  eventId       String    @unique  // External API event ID
  date          DateTime
  time          String?
  country       String
  currency      String?
  event         String    @db.Text
  impact        String    // LOW, MEDIUM, HIGH
  category      String    // Employment, GDP, Inflation, CentralBank, etc.
  actual        String?
  forecast      String?
  previous      String?
  source        String    // API source name
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([date, impact])
  @@index([country, date])
  @@index([currency, date])
}

model EconomicContext {
  id                String     @id @default(uuid())
  analysisId        String     @unique
  analysis          Analysis   @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  symbol            String
  
  // Immediate events (within Â±1 hour)
  upcomingEvents    Json       // Array of event objects
  immediateRisk     String     // NONE, LOW, MEDIUM, HIGH, EXTREME
  
  // Weekly events (within 7 days)
  weeklyEvents      Json       // Array of event objects
  weeklyOutlook     String     // BULLISH, BEARISH, NEUTRAL, VOLATILE
  
  // AI-generated analysis
  impactSummary     String     @db.Text
  warnings          Json       // Array of warning strings
  opportunities     Json       // Array of opportunity strings
  recommendation    String?    @db.Text
  
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
}

model AutomationSchedule {
  id                  String    @id @default(uuid())
  userId              String
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  layoutId            String    @unique
  layout              Layout    @relation(fields: [layoutId], references: [id], onDelete: Cascade)
  
  enabled             Boolean   @default(true)
  frequency           String    // "15m", "1h", "4h", "1d", "1w"
  customCron          String?   // For future custom schedules
  
  sendToTelegram      Boolean   @default(true)
  
  lastRunAt           DateTime?
  nextRunAt           DateTime?
  
  // Alert filters
  onlyOnSignalChange  Boolean   @default(false)  // Only alert if signal changes
  minConfidence       Int       @default(0)      // Minimum confidence (0-100)
  sendOnHold          Boolean   @default(false)  // Send HOLD signals
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@index([nextRunAt, enabled])
  @@index([userId])
}

model TelegramConfig {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  chatId          String    // Telegram chat ID
  username        String?   // Telegram username
  
  isActive        Boolean   @default(true)
  
  // Message preferences
  includeChart    Boolean   @default(true)   // Send chart image
  includeEconomic Boolean   @default(true)   // Include economic context
  notifyOnHold    Boolean   @default(false)  // Send HOLD signals
  
  verifiedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model AnalysisHistory {
  id               String    @id @default(uuid())
  analysisId       String
  analysis         Analysis  @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  
  previousAction   String    // Previous action for comparison
  newAction        String    // New action
  signalChanged    Boolean   // True if action changed
  
  notificationSent Boolean   @default(false)
  sentAt           DateTime?
  
  createdAt        DateTime  @default(now())
  
  @@index([analysisId, createdAt])
}
